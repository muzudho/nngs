# nngs

勉強しようぜ☆（＾～＾）  
Git hub のフォークの使い方が分からん☆（＾～＾）どうなってるんだぜ☆（＾～＾）？  


## NNGS SERVER の README を読もうぜ☆（＾～＾）

(^q^) Linuxの圧縮形式の tarball に含まれているこのファイルは  
No Name Go Server(NNGS)のソースコードです。  

ライセンスは COPYING ファイルを見て。  


## 設定ファイルが変った☆（＾～＾）

(^q^) 設定ファイルの構成が変ったらしいが、初めてみるわたしには関係ないしな☆  

(^q^) 設定は 単一の nngs.cnf ファイルにまとめました。  
`./configure` コマンドを実行すると ほとんど構成終わり☆  

(^q^) そのコマンドで 既存の設定ファイルへの移行をやってくれたらしい☆  
わたしには関係ないな☆（＾～＾）  

(^q^) その設定には、ファイルとディレクトリーに関する項目がある。それらがおかしいと、おかしくなる☆  

(^q^) 起動時に 設定ファイルがなければ、デフォルトのを勝手に作る。  

(^q^)
(1) 前述のように設定ファイルを処理する☆  
(2) そのあと nngssrv は カレント・ディレクトリに 'written.cnf' を書き出す。  
フォーマットは 設定ファイルと同じ。この内容がプログラムで実際に使われている設定☆  

## インストールについて☆（＾～＾）

(^q^) NNGS は、使っていなくても mlrate が必要です☆ なんてこった☆（＾～＾）  
残念なことにオリジナルの（pemの）mlrate は autoconfd/automaked (AC/AM) ではありません☆ 何それ☆（＾～＾）  

(^q^) あなたが AC/AM を手に入れられなかったなら、手動で `src/` ディレクトリーの下にそれらを移動してください☆（＾～＾）  

Step 1:  

(^q^) NNGS を設定する前に mlrate の構成とコンパイルをしろ☆  
次のようにしろ（バージョン番号は異なることがある）  

```shell
# tar xvzf mlrate-1.0.xx.tar.gz
# cd mlrate-1.0.xx
# ./configure
# make
# cd ..
```

(^q^) mlrate ディレクトリーの README ファイルを読め☆  
レーティング・システムを働かせる有用な情報がある☆  

step 2:  

tarball を解凍しろ、mlrate ディレクトリーへシンボリック・リンクを貼れ、  

```shell
# tar xvzf nngs-1.1.yy.tar.gz
# cd nngs-1.1.yy
# ln -s ../mlrate-1.0.xx mlrate
# ./configure --prefix=/whatever/dir/you/want/to/install/it/in/
# make
# make install
```

(^q^)'make install' コマンドは サーバーの機能を働かせるために必要なすべての基本的なヘルプファイルを
インストールするぜ☆ しなかったと思うけどなあ☆（＾～＾）

(^q^)サーバーに必要なすべてのファイルは、 --prefix の下にインストールされる☆
そのディレクトリーは NNGSバイナリが書込み可能にしろ☆
data (players,games,logfile) ファイルもその下に入れる。
サーバーの実行によって それらのファイルはでかくなるから定期的にチェックしろよ☆

To run and test it:

```shell
# $prefix/bin/nngssrv &
# telnet localhost 9696
```

## (^q^) NNGSの古いバージョンをお持ちの方へ☆

いないだろこの章飛ばせだぜ☆（＾～＾）

(^q^) --prefix は古いバージョンを持ってるやつへの対策だったようだな☆

## データ ファイル

(^q^) データとログファイルは $prefix/share/nngssrv/* にある☆
設定ファイルで設定しろ☆

(^q^) 損傷を避けるために、いくつかのファイルは自動ではインストールしない。
手動でインストールしろ☆
`$prefix/nngssrv/ladder` には２つの ladder ファイルの例がある☆
末尾の '.example' を削除するとか☆

(^q^) `$prefix/nngssrv/messages` には ログイン、ログアウトなどの
デフォルトメッセージがある☆
'default.' を削除すればアクティブになる☆

## (^q^) 代りの場所を設定するなら☆

(^q^) 起動時に、 nngssrv は カレント・ディレクトリにある nngs.cnf ファイルから
設定を読み込もうとする☆
または `-c pathname` で指定しろ☆
(^q^) 再コンパイル不要、起動するだけでいい☆　ということかだぜ☆（＾～＾）

(^q^) データと nngssrv バイナリを別の場所に置くことができる☆
または、 ログファイルを `/var/` の中に置くことができる☆
しかし ワイルドな選択をしないことをおススメする ;-)

最も簡単な設定方法:  

1. NNGS を設定し、コンパイルし、インストールする☆
2. バイナリを開始。そしてそれを強制終了☆
3. 現在のディレクトリに書き出された nngs.cnf を編集☆ 設定ファイルには 一目瞭然のコメントが書いてある☆
4. 将来のバージョンでは おそらくさらに設定ファイルに項目が追加されるでしょう☆  
   可能な追加については、 nngs.cnf または written.cnf を調べてください☆

--------------------------------------------
-- RUNNING NNGS FROM INSIDE A CHROOT() 'JAIL'
--------------------------------------------

If you want nngs to run in a chroot()ed environment ('jail')
, you'll have to do some manual tuning.

*************************************************
*** NOTE: if you don't know what chroot() is, ***
*** you will probably *not* want it!          ***
*************************************************

1) the chroot() systemcall itself requires root privileges.
   nngssrv starts as root, then
   - chdir()s to its cage
   - chroot()s
   fork()s twice
   - , and changes gid and uid.
   Currently, it does *not* 
   - close filedescriptors,
   - change process group,
   - detach from its CTTY.
   Just the two forks should do.

2) Mail cannot be sent fom a chroot()ed program using /usr/bin/mail et.al.
   (unless a copy exists in the jail, which will also need the loader, and
   part of the /lib/*so, and maybe more)
   If you configure the mailer to be SMTP (by setting mail_program=SMTP),
   a built-in mailer is used. This will only need gethostbyname(), which
   relies on /etc/hosts and/or /etc/resolv.conf. These files need to be
   present in the jail, or mail won't work.

3) For safety: if anything fails (chroot, setuid, ...) the program will
   refuse to work and will exit() before doing anything useful.

4) Maybe (?depending on platform?) other files (/dev/zero?) are needed.

5) As an aid in debugging, a file "written.cnf" is written inside the
   chroot() -jail. The pathnames in this file will be relative to the
   chroot() directory. (the prefix is snipped) You can use this to check
   NNGS's assumptions about where things should be located.

6) YMMV

---------------------------------------------------
-- USERS AND ADMINS
---------------------------------------------------

In nngs-1.1.22, an admin-account is automatically added 
if it is not found at server startup.
**********************************************
** this admin-account has NO PASSWORDr      **
** you'll have to SET A PASSWORD IMMEDIATELY**
**********************************************

(in older versions: When you install NNGS for the first time, you'll need to manually
create a user with 'admin' - rights. This can be ANY valid name.
Once there is an admin-account, it can be used to grant admin-rights
to other users.)

NOTE: the admin-status is stored in TWO places: the userfile proper,
and a lists/admin - file. You'l need both.
NOTE2: a running NNGS-server may have most of it's files cached.
editing the underlying files may not have the desired effects.
To be safe: stop the server before editing the files.

There already is a user 'admin' in the lists/admins.default -file
; you'll need to:
1) create a user named 'admin' by logging in and using
   the 'register' -command, and logging out.
2a) stop the server
2b) manually edit the user file for 'admin' in .../players/a/admin:
   change the line:
VARS: 1:4:0:1:0:1:1:0 :0:1:1:0:1:1:0:0 :0:0:0:0:0:0:0:0 :0:4:1:3:90:19:10:25 :33:0:0:33
   to:
VARS: 1:4:0:1:0:1:1:0 :0:1:1:0:1:1:0:0 :0:100:0:0:0:0:0:0 :0:4:1:3:90:19:10:25 :33:0:0:33
   (this field is the adminLevel)---------^^^
3a) restart the server
3b) on the next logon, the 'admin' account will have unlimited rights.

-----------------------------------------------------
-- DEVELOPMENT
-----------------------------------------------------

The server code is undergoing development and contributions are
welcome.  See:

<http://www.sourceforge.org/nngs>

for the latest status and sources.
Contributions and suggestions are welcome.

When sending patches that span several files, please use
diff -ruN <orig-dir> <modified-dir>


>> MAJOR CHANGES

Major changes since the beginning of this project:
- autoconf and automake so it compiles easily on many platforms, even windoze
- clean source tree
... all help files, admin files etc. included
... a 'make install' will install a working server
... all data dirs organized into one place ($prefix/nngssrv)
... all game and player dirs created on install
- nngs local malloc() and salloc() removed
- mlrate cleaned up
- (most) format strings taken out of the code
- internationalization
... chinese (messages and help files) (courtesy of LGS)
... german (messages only)
... others to follow
- added some caching, to reduce reading/writing of playerdb to/from disk.
- changed clock resolution for games to 0.1 sec.
- moved configuration into .cnf file.
- removed (most of) the compiled-in filenames.
- added chroot() support.
- experimental UDP port, to be used by a PHP/web interface.

>> WINDOWS

The server now works on windows as well!  Here's how:
- Get and install cygwin (>=1.1.8) from http://www.cygwin.com
- follow the instructions above to compile and install as on unix
- NOTE: windows-build has not been tried since 2002. YMMV.

